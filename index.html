<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROULETTE AI - GALE (Xiino Edition)</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- VARIABLES DE COLOR Y BASE --- */
        :root {
            --neon-cyan: #00ffff; --neon-pink: #ff0080; --neon-green: #00ff41;
            --neon-red: #ff1f1f; --neon-blue: #0080ff; --neon-purple: #8a2be2;
            --neon-orange: #ff4500; --neon-yellow: #ffff00; --dark-bg: #0a0a0f;
            --darker-bg: #050508; --glass-bg: rgba(0, 255, 255, 0.05);
            --glass-border: rgba(0, 255, 255, 0.2); --text-primary: #fff;
            --text-secondary: #b0b0b0; --shadow-glow: 0 0 15px; --shadow-glow-l: 0 0 25px;
            --font-display: 'Orbitron', sans-serif; --font-body: 'Rajdhani', sans-serif;
            --num-red: #E74C3C; --num-black: #34495E; --num-green: #2ECC71;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-body); background-color: var(--dark-bg);
            color: var(--text-primary); display: flex; justify-content: center;
            align-items: center; min-height: 100vh; padding: 20px;
            background-image: linear-gradient(45deg, var(--darker-bg) 25%, transparent 25%),
                              linear-gradient(-45deg, var(--darker-bg) 25%, transparent 25%),
                              linear-gradient(45deg, transparent 75%, var(--darker-bg) 75%),
                              linear-gradient(-45deg, transparent 75%, var(--darker-bg) 75%);
            background-size: 20px 20px;
        }

        /* --- CONTENEDOR PRINCIPAL --- */
        #app-container {
            width: 100%; max-width: 600px;
            background: var(--darker-bg); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 24px;
            box-shadow: var(--shadow-glow) var(--neon-cyan), inset 0 0 40px rgba(0, 255, 255, 0.1);
            display: flex; flex-direction: column; gap: 20px;
            animation: fadeIn 1s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* --- CAJA DE RECOMENDACI√ìN (ESTADO) --- */
        .reco-box {
            border: 2px solid; padding: 20px; border-radius: 8px;
            text-align: center; background: var(--glass-bg);
            transition: all 0.3s ease;
        }
        .reco-box h2 {
            font-family: var(--font-display); font-weight: 700;
            font-size: 1.5rem; margin-bottom: 15px; letter-spacing: 1px;
            text-transform: uppercase;
        }
        .reco-content { min-height: 50px; }
        .reco-content p {
            font-size: 2.25rem; font-weight: 900; line-height: 1.2;
            font-family: var(--font-display);
        }
        .reco-content span { font-size: 0.9rem; font-weight: 400; color: var(--text-secondary); }

        /* Estados de la caja */
        .reco-box.idle { border-color: var(--neon-blue); box-shadow: var(--shadow-glow) var(--neon-blue); }
        .reco-box.idle h2 { color: var(--neon-blue); }
        .reco-box.idle .reco-content p { color: var(--text-secondary); }

        .reco-box.active-bet { border-color: var(--neon-cyan); box-shadow: var(--shadow-glow) var(--neon-cyan); }
        .reco-box.active-bet h2 { color: var(--neon-cyan); animation: pulse 1.5s infinite; }
        .reco-box.active-bet .reco-content p { color: var(--neon-cyan); }
        
        .reco-box.gale { border-color: var(--neon-orange); box-shadow: var(--shadow-glow) var(--neon-orange); }
        .reco-box.gale h2 { color: var(--neon-orange); }
        .reco-box.gale .reco-content p { color: var(--neon-orange); }

        .reco-box.win { border-color: var(--neon-green); box-shadow: var(--shadow-glow) var(--neon-green); }
        .reco-box.win h2 { color: var(--neon-green); }
        .reco-box.win .reco-content p { color: var(--neon-green); }

        .reco-box.loss { border-color: var(--neon-red); box-shadow: var(--shadow-glow) var(--neon-red); }
        .reco-box.loss h2 { color: var(--neon-red); }
        .reco-box.loss .reco-content p { color: var(--neon-red); }

        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        /* --- HISTORIAL DE N√öMEROS --- */
        .history-box {
            display: flex; flex-wrap: wrap-reverse; justify-content: center;
            gap: 5px; padding: 10px; background: var(--dark-bg);
            border-radius: 6px; border: 1px solid var(--glass-border);
            min-height: 40px;
        }
        .num {
            width: 28px; height: 28px; display: inline-flex;
            justify-content: center; align-items: center;
            border-radius: 50%; font-weight: 700; font-size: 0.9rem;
            color: #fff; background-color: var(--num-black);
            transition: transform 0.3s ease;
        }
        .num.red { background-color: var(--num-red); }
        .num.green { background-color: var(--num-green); }
        .num:first-child {
            transform: scale(1.15); border: 2px solid var(--neon-cyan);
            box-shadow: var(--shadow-glow) var(--neon-cyan);
        }

        /* --- CONTROLES DE ENTRADA --- */
        .controls { display: flex; gap: 10px; }
        .controls input {
            flex-grow: 1; background: var(--glass-bg); border: 1px solid var(--glass-border);
            color: var(--text-primary); border-radius: 6px; padding: 0 15px;
            font-family: var(--font-body); font-size: 1.2rem; font-weight: 700;
            outline: none; transition: all 0.3s ease;
        }
        .controls input:focus { border-color: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); }
        .controls button {
            background: var(--neon-cyan); color: var(--darker-bg); border: none;
            border-radius: 6px; padding: 10px 20px; font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: all 0.3s ease;
            font-family: var(--font-display);
        }
        .controls button:hover { background: #fff; box-shadow: var(--shadow-glow) var(--neon-cyan); }

        /* --- GRID DE ESTAD√çSTICAS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .stat-card {
            background: var(--dark-bg); border: 1px solid var(--glass-border);
            border-radius: 6px; padding: 15px;
        }
        .stat-card h3 {
            font-family: var(--font-display); font-size: 0.9rem;
            color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase;
        }
        .stat-card p {
            font-size: 1.75rem; font-weight: 700;
            font-family: var(--font-display); color: var(--text-primary);
        }
        .stat-card.phase p { color: var(--neon-purple); }
        .stat-card.mode p { color: var(--neon-orange); }
        .stat-card.accuracy-n p { color: var(--neon-cyan); }
        .stat-card.accuracy-o p { color: var(--neon-pink); }

        /* --- CAMBIADOR DE MODO --- */
        .mode-switcher { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mode-switcher button {
            background: transparent; border: 2px solid var(--glass-border);
            color: var(--text-secondary); border-radius: 6px; padding: 12px;
            font-weight: 700; font-size: 1rem; cursor: pointer;
            transition: all 0.3s ease; font-family: var(--font-display);
        }
        .mode-switcher button:hover { border-color: var(--text-primary); color: var(--text-primary); }
        .mode-switcher button.active {
            color: var(--darker-bg); background: var(--neon-cyan);
            border-color: var(--neon-cyan); box-shadow: var(--shadow-glow) var(--neon-cyan);
        }
        /* Asigna color al otro bot√≥n activo */
        .mode-switcher button.active-outside {
            background: var(--neon-pink); border-color: var(--neon-pink);
            box-shadow: var(--shadow-glow) var(--neon-pink);
        }

        /* --- NOTIFICACI√ìN TOAST --- */
        #toast {
            position: fixed; top: 20px; right: 20px; background-color: var(--neon-cyan);
            color: var(--darker-bg); padding: 15px 25px; border-radius: 6px;
            font-family: var(--font-display); font-weight: 700;
            box-shadow: var(--shadow-glow-l) var(--neon-cyan);
            transform: translateX(120%); transition: transform 0.5s ease;
            z-index: 1000;
        }
        #toast.show { transform: translateX(0); }
        #toast.error { background-color: var(--neon-red); box-shadow: var(--shadow-glow-l) var(--neon-red); }

    </style>
</head>
<body>

    <div id="app-container">
        
        <div class="reco-box idle" id="reco-box">
            <h2 id="game-state">CARGANDO...</h2>
            <div class="reco-content" id="reco-content">
                <p>Inicializando...</p>
                <span>Conectando al servidor...</span>
            </div>
        </div>

        <div class="history-box" id="history-box">
            </div>

        <div class="controls">
            <input type="number" id="num-input" placeholder="N¬∞ Manual...">
            <button id="btn-submit">Enviar</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card phase">
                <h3>Fase</h3>
                <p id="stat-phase">--</p>
            </div>
            <div class="stat-card mode">
                <h3>Datos</h3>
                <p id="stat-data-count">--</p>
            </div>
            <div class="stat-card accuracy-n">
                <h3>Acc (Vecinos)</h3>
                <p id="stat-acc-n">--%</p>
            </div>
            <div class="stat-card accuracy-o">
                <h3>Acc (Externas)</h3>
                <p id="stat-acc-o">--%</p>
            </div>
        </div>

        <div class="mode-switcher">
            <button id="btn-neighbors" class="active">Vecinos</button>
            <button id="btn-outside">Externas</button>
        </div>
    </div>

    <div id="toast">Mensaje</div>

    <script>
        // --- ¬°MODIFICADO! Esta es la URL de tu API en Railway ---
        const API_URL = 'https://xiinoo-production.up.railway.app'; // URL de Railway
        
        // --- ELEMENTOS DEL DOM ---
        const elements = {
            recoBox: document.getElementById('reco-box'),
            gameState: document.getElementById('game-state'),
            recoContent: document.getElementById('reco-content'),
            historyBox: document.getElementById('history-box'),
            numInput: document.getElementById('num-input'),
            btnSubmit: document.getElementById('btn-submit'),
            statPhase: document.getElementById('stat-phase'),
            statDataCount: document.getElementById('stat-data-count'),
            statAccN: document.getElementById('stat-acc-n'),
            statAccO: document.getElementById('stat-acc-o'),
            btnNeighbors: document.getElementById('btn-neighbors'),
            btnOutside: document.getElementById('btn-outside'),
            toast: document.getElementById('toast')
        };
        
        // --- UTILIDADES (Toast) ---
        let toastTimeoutId = null;
        function showToast(message, isError = false, duration = 3000) {
            if (toastTimeoutId) clearTimeout(toastTimeoutId);
            elements.toast.textContent = message;
            elements.toast.className = isError ? 'error' : '';
            elements.toast.classList.add('show');
            toastTimeoutId = setTimeout(() => {
                elements.toast.classList.remove('show');
            }, duration);
        }

        // --- L√ìGICA DE UI (Actualizar Vistas) ---
        const ROULETTE_ORDER = [
            0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8,
            23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12,
            35, 3, 26
        ];
        const RED_NUMBERS = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];

        function getNumColor(num) {
            if (num === 0) return 'green';
            return RED_NUMBERS.includes(num) ? 'red' : 'black';
        }

        function updateHistory(history = [], lastNumber = null) {
            elements.historyBox.innerHTML = '';
            // Tomamos los √∫ltimos 20 para mostrar
            const recentHistory = history.slice(-20).reverse();
            
            recentHistory.forEach((num, index) => {
                const numEl = document.createElement('div');
                numEl.className = `num ${getNumColor(num)}`;
                numEl.textContent = num;
                // El primer n√∫mero (el m√°s reciente) recibe el destaque
                if (index === 0) {
                    numEl.style.transform = 'scale(1.15)';
                    numEl.style.border = '2px solid var(--neon-cyan)';
                    numEl.style.boxShadow = 'var(--shadow-glow) var(--neon-cyan)';
                }
                elements.historyBox.appendChild(numEl);
            });
        }

        function updateStats(statsData) {
            if (!statsData) return;
            const { global, neighbors, outside } = statsData;
            
            if (global) {
                elements.statPhase.textContent = global.phase || '--';
                elements.statDataCount.textContent = global.data_count || '0';
                
                // Actualizar botones de modo
                if (global.current_mode === 'neighbors') {
                    elements.btnNeighbors.classList.add('active');
                    elements.btnOutside.classList.remove('active', 'active-outside');
                } else {
                    elements.btnNeighbors.classList.remove('active');
                    elements.btnOutside.classList.add('active', 'active-outside');
                }
            }
            if (neighbors) {
                elements.statAccN.textContent = `${neighbors.accuracy_percentage || 0}%`;
            }
            if (outside) {
                elements.statAccO.textContent = `${outside.accuracy_percentage || 0}%`;
            }
        }
        
        function updateUI(data) {
            // Esta funci√≥n es un wrapper, la l√≥gica principal est√° en processData
            processData(data);
        }

        // --- L√ìGICA DE COMUNICACI√ìN (API) ---

        async function processNumber() {
            const numStr = elements.numInput.value;
            if (numStr === '') return;
            
            const number = parseInt(numStr, 10);
            if (isNaN(number) || number < 0 || number > 36) {
                showToast('N√∫mero inv√°lido (0-36)', true);
                return;
            }
            
            elements.numInput.value = '';
            elements.btnSubmit.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}/process_number`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ number: number })
                });
                
                if (!response.ok) {
                    // El error de "timeout" (504) se captura aqu√≠
                    if (response.status === 504) {
                        showToast('El servidor est√° pensando (Timeout)... Reintentando.', true);
                    } else {
                        throw new Error(`Error ${response.status}`);
                    }
                }
                
                const data = await response.json();
                // processData se llamar√° desde el long-polling, 
                // pero lo llamamos aqu√≠ para una respuesta instant√°nea
                // (como "Analizando...")
                processData(data); 

            } catch (error) {
                console.error("Error al procesar n√∫mero:", error);
                showToast('Error de Red al enviar. Revisa la consola.', true);
            } finally {
                elements.btnSubmit.disabled = false;
            }
        }

        async function setMode(mode) {
            try {
                const response = await fetch(`${API_URL}/set_mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: mode })
                });
                if (!response.ok) throw new Error('No se pudo cambiar el modo');
                
                const data = await response.json();
                updateStats(data.stats);
                showToast(`Modo cambiado a ${mode}`, false);
                
            } catch (error) {
                console.error("Error al cambiar modo:", error);
                showToast('Error al cambiar modo', true);
            }
        }

        // --- ¬°¬°¬°FUNCI√ìN CLAVE MODIFICADA!!! ---
        // Esta funci√≥n lee la respuesta "plana" del backend y actualiza la UI.
        // Arregla el bug de "Victoria ? G0".
        function processData(data) {
            // 1. Actualiza siempre el historial y las estad√≠sticas
            if (data.history) {
                updateHistory(data.history, data.last_number);
            }
            if (data.stats) {
                updateStats(data.stats);
            }
        
            // 2. Extrae la informaci√≥n de la acci√≥n (si la hay)
            const action = data.action;
            // 'bet_details' puede no existir en un 'WAIT', por eso 'data.response'
            const responseData = data.response || data; 
            const betDetails = responseData.bet_details;
            const message = responseData.message;
            const winLevel = responseData.win_level;
            
            // Construye el nombre de la apuesta de forma segura
            let betName = '?';
            if (betDetails) {
                betName = betDetails.bet || (betDetails.base_numbers ? `Par ${betDetails.base_numbers.join(',')}` : '?');
            }
        
            // 3. Act√∫a seg√∫n la acci√≥n
            switch (action) {
                case 'NEW_BET':
                    elements.gameState.textContent = "¬°NUEVA ENTRADA!";
                    elements.recoContent.innerHTML = `
                        <p>${betName}</p>
                        <span>N√∫meros: ${betDetails.covered_numbers.join(', ')}</span>
                    `;
                    elements.recoBox.className = 'reco-box active-bet';
                    showToast(`üîî ¬°Nueva Se√±al! ${betName}`, false, 4000);
                    break;
                
                case 'WIN':
                    elements.gameState.textContent = "¬°VICTORIA!";
                    elements.recoContent.innerHTML = `<p>${betName}</p><span>Victoria en G${winLevel.replace('INITIAL', '0')}</span>`;
                    elements.recoBox.className = 'reco-box win';
                    showToast(`üéâ ¬°VICTORIA! ${betName} (G${winLevel.replace('INITIAL', '0')})`, false, 4000);
                    break;
        
                case 'LOSS':
                    elements.gameState.textContent = "PERDIDA";
                    elements.recoContent.innerHTML = `<p>${betName}</p><span>Perdida. En Cooldown...</span>`;
                    elements.recoBox.className = 'reco-box loss';
                    showToast(`‚ùå P√©rdida. (G2)`, true, 4000);
                    break;
        
                case 'G1':
                case 'G2':
                    elements.gameState.textContent = `APUESTA EN G${action === 'G1' ? 1 : 2}`;
                    elements.recoContent.innerHTML = `<p>${betName}</p><span>Esperando resultado G${action === 'G1' ? 1 : 2}...</span>`;
                    elements.recoBox.className = 'reco-box active-bet gale';
                    showToast(`Martingala ${action} activada...`, false, 3000);
                    break;
        
                case 'COOLDOWN':
                    elements.gameState.textContent = "‚è∏Ô∏è COOLDOWN";
                    elements.recoContent.innerHTML = `<p>Esperando ${responseData.rounds_left} rondas...</p>`;
                    elements.recoBox.className = 'reco-box idle';
                    break;
        
                case 'WAIT': // Respuesta r√°pida de 'process_number'
                    elements.gameState.textContent = "üß† ANALIZANDO...";
                    elements.recoContent.innerHTML = `<p>${message || 'Calculando se√±al...'}</p>`;
                    elements.recoBox.className = 'reco-box idle';
                    break;
        
                case 'LEARNING':
                case 'BULK_UPDATE':
                case 'READY':
                case 'IDLE':
                case 'NO_UPDATE':
                default:
                    // No hacer nada si es un 'NO_UPDATE' o un estado de espera
                    if (action !== 'NO_UPDATE') {
                        // Solo actualiza si no hay una apuesta activa
                        const currentState = elements.gameState.textContent;
                        if (!currentState.includes('VICTORIA') && !currentState.includes('ENTRADA') && !currentState.includes('APUESTA')) {
                            elements.gameState.textContent = "ESPERANDO SE√ëAL";
                            elements.recoContent.innerHTML = `<p>${message || 'Monitorizando...'}</p>`;
                            elements.recoBox.className = 'reco-box idle';
                        }
                    }
                    break;
            }
        }


        // --- LONG POLLING ---
        async function startLongPolling() {
            let errorCount = 0;
            while (true) {
                try {
                    const response = await fetch(`${API_URL}/listen_for_updates`);
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}`);
                    }
                    const data = await response.json();
                    
                    // Aqu√≠ es donde la "Tarea en Segundo Plano" notifica a la UI
                    if (data.action !== 'NO_UPDATE') {
                        console.log('Long Poll Recibido:', data);
                        processData(data); // Procesa la actualizaci√≥n
                    }
                    errorCount = 0; // Reset error count on success
                    
                } catch (error) {
                    console.error("Error en Long Polling:", error);
                    errorCount++;
                    if (errorCount > 3) {
                        showToast('Error de conexi√≥n. Reintentando en 10s.', true);
                        await new Promise(resolve => setTimeout(resolve, 10000));
                    } else {
                        await new Promise(resolve => setTimeout(resolve, 3000));
                    }
                }
            }
        }

        async function getInitialState() {
            try {
                const response = await fetch(`${API_URL}/initial_state`);
                if (!response.ok) throw new Error('No se pudo cargar el estado inicial');
                
                const data = await response.json();
                // updateUI(data); // 'updateUI' fue mi error, 'data' no tiene 'action'
                // Correcci√≥n: Llamar a las funciones espec√≠ficas
                updateHistory(data.history || [], data.history ? data.history[data.history.length-1] : null);
                updateStats(data.stats || {});
                
            } catch (error) {
                console.error("Error al cargar estado inicial:", error);
                elements.gameState.textContent = "ERROR";
                showToast('Error al conectar', true, 5000);
            }
        }

        // --- INICIALIZACI√ìN ---
        function initialize() {
            console.log('üé∞ ROULETTE AI - Inicializando...');
            
            elements.btnSubmit.addEventListener('click', processNumber);
            elements.numInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') processNumber();
            });
            
            elements.btnNeighbors.addEventListener('click', () => setMode('neighbors'));
            elements.btnOutside.addEventListener('click', () => setMode('outside'));

            getInitialState();
            startLongPolling();
        }

        document.addEventListener('DOMContentLoaded', initialize);
        
        window.addEventListener('beforeunload', () => {
            clearTimeout(toastTimeoutId);
        });
    </script>
</body>
</html>
